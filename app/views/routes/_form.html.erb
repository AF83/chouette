<%= semantic_form_for [@referential, @line, @route] do |form| %>
  <%= form.inputs do %>
    <%= form.input :name %>
    <%= form.input :published_name %>
    <%= form.input :number %>
    <%= form.input :comment %>
    <%= form.input :opposite_route, :as => :select, :collection => @line.routes.select { |r| r.id != @route.id } %>
    <%= form.input :direction_code, :as => :select, :collection => Chouette::Route.directions, :include_blank => false, :member_label => Proc.new { |mode| t("directions.label.#{mode}") } %>
    <%= form.input :wayback_code, :as => :select, :collection => Chouette::Route.waybacks, :include_blank => false, :member_label => Proc.new { |mode| t("waybacks.label.#{mode}") } %>
    <%= form.input :objectid, :required => !@route.new_record?, :input_html => { :disabled => !@route.new_record? } %>
  <% end %>
	<div id="stop_points">
		<%= form.semantic_fields_for :stop_points, :include_id => false, :label => "TOTO" do |p| %>
		  <%= render "stop_point_fields",  :f => p %>
		<% end %>
    <div class="links">
	    <%= link_to_add_association t("routes.actions.add_stop_point"), form, :stop_points, :class => 'add_stop_point' %>
    </div>   
	</div>   

   <%= form.actions do %>
     <%= form.action :submit, :as => :button %>
     <%= form.action :cancel, :as => :link %>
   <% end %>
<% end %>
   
<script>
var stop_point_ids = [];  
var order_position;

order_position = function() {
  $('#stop_points input[type="hidden"][id$="position"]').each(function(index) {
    $(this).val(index);
  });
};

  $('#stop_points').sortable({
      axis: 'y',
      dropOnEmpty: false,
      handle: '.handle',
      cursor: 'crosshair',
      items: '.stop_point',
      opacity: 0.4,
      scroll: true,
      start: function( event, ui ) {
        stop_point_ids = $('#stop_points input[type="hidden"][class="stop_point_id"]').map(function() {
          return $(this).val();
        }); },  
      update: function( event, ui ) {  
        $('#stop_points input[type="hidden"][class="stop_point_id"]').each(function(index) {
          $(this).attr("value", stop_point_ids[index])
        });
        order_position();
      }
  });

$('#stop_points').bind("cocoon:after-insert", function(event) {
  order_position();
});

$('#stop_points').bind("cocoon:after-remove", function(event) {
  order_position();
});

  
</script>

